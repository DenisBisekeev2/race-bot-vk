{% extends "base.html" %}

{% block title %}Вход{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8 col-lg-6">
        <div class="car-card p-4">
            <div class="text-center mb-4">
                <h2 class="racing-font mb-3" style="font-size: 2.5rem;">
                    <i class="fas fa-sign-in-alt me-2"></i>ВХОД
                </h2>
                <p class="lead">Войдите через VK ID чтобы управлять своим гаражом</p>
            </div>

            <!-- Контейнер для VK ID виджета -->
            <div class="text-center mb-4 p-4 border-gradient rounded-3" id="vk-auth-container">
                <div class="d-flex flex-column align-items-center">
                    <div class="mb-3">
                        <i class="fas fa-car fa-3x text-gradient"></i>
                    </div>
                    <h4 class="mb-3">Вход через VK ID</h4>
                    
                    <!-- Спиннер загрузки -->
                    <div class="d-flex justify-content-center align-items-center" style="min-height: 60px;">
                        <div>
                          <script nonce="csp_nonce" src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
                          <script nonce="csp_nonce" type="text/javascript">
                            
    // Инициализация VK ID
    document.addEventListener('DOMContentLoaded', function() {
        if ('VKIDSDK' in window) {
            const VKID = window.VKIDSDK;

            VKID.Config.init({
                app: 54417533,
                redirectUrl: '{{ url_for("vk_auth_callback", _external=True) }}',
                responseMode: VKID.ConfigResponseMode.Callback,
                source: VKID.ConfigSource.LOWCODE,
                scope: 'email',
            });

            const oneTap = new VKID.OneTap();

            oneTap.render({
                container: document.getElementById('vk_auth_container'),
                showAlternativeLogin: false,
                appearance: {
                    size: 'medium',
                    theme: 'dark'
                }
            })
            .on(VKID.WidgetEvents.ERROR, function(error) {
                console.error('VK ID Error:', error);
            })
            .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
                const code = payload.code;
                const deviceId = payload.device_id;

                VKID.Auth.exchangeCode(code, deviceId)
                    .then(function(data) {
                        // Отправляем токен на сервер
                        fetch('{{ url_for("vk_auth") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                access_token: data.access_token,
                                user_id: data.user_id
                            })
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                window.location.reload();
                            } else {
                                alert('Ошибка авторизации: ' + result.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                    })
                    .catch(function(error) {
                        console.error('Token exchange error:', error);
                    });
            });
        }
    });
</script>
                        </div>
                    </div>
                    
                    <small class="text-muted mt-2">Безопасный вход через официальный VK ID</small>
                </div>
            </div>

            <!-- Сообщения об ошибках/успехе -->
            <div id="auth-messages">
                <div id="error-message" class="alert alert-danger d-none">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="error-text"></span>
                </div>
                <div id="success-message" class="alert alert-success d-none">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="success-text"></span>
                </div>
            </div>

            <div class="text-center mt-4">
                <div class="d-inline-block pulse">
                    <i class="fas fa-chevron-down text-gradient"></i>
                </div>
            </div>

           

            <!-- Информационный блок -->
            <div class="alert alert-info mt-4">
                <h6><i class="fas fa-info-circle me-2"></i> Преимущества VK ID:</h6>
                <ul class="mb-0 ps-3">
                    <li>Мгновенный вход без пароля</li>
                    <li>Высокий уровень безопасности</li>
                    <li>Автоматическое создание аккаунта в боте</li>
                    <li>Синхронизация с вашим VK профилем</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- VK ID SDK -->
<script src="https://unpkg.com/@vkid/sdk@2.x/dist/index.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const VKID = window.VKID;
    
    // Прячем спиннер через 2 секунды (если виджет не загрузится)
    setTimeout(() => {
        document.getElementById('loading-spinner').style.display = 'none';
    }, 2000);
    
    // Инициализация VKID с правильными параметрами
    try {
        VKID.Config.set({
            app: 54417533, // Ваш App ID
            redirectUrl: window.location.origin + '/vk_callback', // Будет обрабатываться Flask
            state: 'racebot_auth', // Любая строка для защиты
            scope: '' // Базовые права - только ID пользователя
        });
        
        console.log('VKID Config установлен');
        
        // Создаем виджет OneTap
        const oneTap = new VKID.OneTap({
            container: document.getElementById('vk-id-widget'),
            showAlternativeLogin: true,
            styles: {
                borderRadius: 12,
                height: 48,
                width: '100%',
                backgroundColor: '#ff2a00'
            }
        });
        
        // Обработка успешного входа
        oneTap.on(VKID.OneTapEvents.LOGIN_SUCCESS, function(event) {
            console.log('LOGIN_SUCCESS:', event.detail);
            
            const code = event.detail.code;
            
            // Показываем сообщение об успехе
            showSuccess('Авторизация...');
            
            // Отправляем код на сервер
            fetch('/vk_auth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    auth_type: 'vk_id'
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response from server:', data);
                
                if (data.success) {
                    showSuccess('Авторизация успешна! Перенаправление...');
                    
                    // Редирект на дашборд
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1500);
                } else {
                    showError(data.error || 'Ошибка авторизации');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                showError('Ошибка соединения с сервером');
            });
        });
        
        // Обработка ошибок
        oneTap.on(VKID.OneTapEvents.LOGIN_FAILED, function(event) {
            console.error('LOGIN_FAILED:', event.detail);
            showError('Ошибка входа через VK ID');
        });
        
        // Рендерим виджет
        oneTap.render();
        
        // Прячем спиннер после рендера
        document.getElementById('loading-spinner').style.display = 'none';
        
        console.log('VKID виджет инициализирован');
        
    } catch (error) {
        console.error('Ошибка инициализации VKID:', error);
        document.getElementById('loading-spinner').style.display = 'none';
        showError('Не удалось загрузить VK ID виджет. Попробуйте обновить страницу.');
    }
    
    // Функции для отображения сообщений
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        errorText.textContent = message;
        errorDiv.classList.remove('d-none');
        document.getElementById('success-message').classList.add('d-none');
    }
    
    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        const successText = document.getElementById('success-text');
        successText.textContent = message;
        successDiv.classList.remove('d-none');
        document.getElementById('error-message').classList.add('d-none');
    }
});
</script>
{% endblock %}
