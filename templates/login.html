{% extends "base.html" %}

{% block title %}Вход{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8 col-lg-6">
        <div class="car-card p-4">
            <div class="text-center mb-4">
                <h2 class="racing-font mb-3" style="font-size: 2.5rem;">
                    <i class="fas fa-sign-in-alt me-2"></i>ВХОД
                </h2>
                <p class="lead">Войдите через VK ID чтобы управлять своим гаражом</p>
            </div>

            <!-- Контейнер для VK ID виджета -->
            <div class="text-center mb-4 p-4 border-gradient rounded-3">
                <div class="d-flex flex-column align-items-center">
                    <div class="mb-3">
                        <i class="fas fa-car fa-3x text-gradient"></i>
                    </div>
                    <h4 class="mb-3">Вход через VK ID</h4>
                    
                    <!-- Контейнер для виджета -->
                    <div id="vk_auth_container" style="min-height: 60px; width: 100%; max-width: 300px; margin: 0 auto;"></div>
                    
                    <small class="text-muted mt-2">Безопасный вход через официальный VK ID</small>
                </div>
            </div>

            <!-- Сообщения об ошибках/успехе -->
            <div id="auth-messages">
                <div id="error-message" class="alert alert-danger d-none">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="error-text"></span>
                </div>
                <div id="success-message" class="alert alert-success d-none">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="success-text"></span>
                </div>
            </div>

            <div class="text-center mt-4">
                <div class="d-inline-block pulse">
                    <i class="fas fa-chevron-down text-gradient"></i>
                </div>
            </div>

            <!-- Информационный блок -->
            <div class="alert alert-info mt-4">
                <h6><i class="fas fa-info-circle me-2"></i> Преимущества VK ID:</h6>
                <ul class="mb-0 ps-3">
                    <li>Мгновенный вход без пароля</li>
                    <li>Высокий уровень безопасности</li>
                    <li>Автоматическое создание аккаунта в боте</li>
                    <li>Синхронизация с вашим VK профилем</li>
                </ul>
            </div>
            
            <!-- Альтернативный способ для старых браузеров -->
            <div class="text-center mt-4">
                <a href="{{ url_for('login_legacy') }}" class="btn btn-outline-racing">
                    <i class="fas fa-mobile-alt me-2"></i>Войти по ID
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    /* Стили для VK ID виджета */
    #vk_auth_container {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .VkIdWebSdk__button_reset {
        border-radius: 10px !important;
        overflow: hidden !important;
        background: var(--gradient) !important;
        border: none !important;
        height: 48px !important;
        padding: 0 20px !important;
        font-weight: 600 !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем VK ID SDK динамически
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/@vkid/sdk@2.0.0/dist-sdk/umd/index.js';
    script.onload = function() {
        if (window.VKIDSDK) {
            const VKID = window.VKIDSDK;
            
            // Получаем текущий URL для redirect
            const currentUrl = window.location.origin + window.location.pathname;
            const redirectUrl = '{{ url_for("vk_auth_callback", _external=True) }}';
            
            console.log('VK ID SDK загружен, redirect URL:', redirectUrl);
            
            try {
                VKID.Config.init({
                    app: 54417533,
                    redirectUrl: redirectUrl,
                    responseMode: VKID.ConfigResponseMode.Callback,
                    source: VKID.ConfigSource.LOWCODE,
                    scope: 'email',
                });

                const oneTap = new VKID.OneTap();

                oneTap.render({
                    container: document.getElementById('vk_auth_container'),
                    showAlternativeLogin: true,
                    appearance: {
                        size: 'medium',
                        theme: 'dark',
                        borderRadius: 10
                    }
                })
                .on(VKID.WidgetEvents.ERROR, function(error) {
                    console.error('VK ID Error:', error);
                    showError('Ошибка при загрузке виджета VK ID. Попробуйте обновить страницу.');
                })
                .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
                    console.log('Login success payload:', payload);
                    
                    if (!payload.code) {
                        showError('Ошибка получения кода авторизации');
                        return;
                    }
                    
                    const code = payload.code;
                    const deviceId = payload.device_id || 'web';

                    VKID.Auth.exchangeCode(code, deviceId)
                        .then(function(data) {
                            console.log('Token exchange success:', data);
                            
                            if (!data.access_token || !data.user_id) {
                                showError('Ошибка получения токена');
                                return;
                            }
                            
                            // Отправляем токен на сервер
                            fetch('{{ url_for("vk_auth") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    access_token: data.access_token,
                                    user_id: data.user_id
                                })
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Ошибка сети');
                                }
                                return response.json();
                            })
                            .then(result => {
                                console.log('Server response:', result);
                                if (result.success) {
                                    showSuccess('Успешная авторизация! Перенаправление...');
                                    setTimeout(() => {
                                        window.location.href = '{{ url_for("dashboard") }}';
                                    }, 1000);
                                } else {
                                    showError('Ошибка авторизации: ' + (result.error || 'Неизвестная ошибка'));
                                }
                            })
                            .catch(error => {
                                console.error('Fetch error:', error);
                                showError('Ошибка соединения с сервером');
                            });
                        })
                        .catch(function(error) {
                            console.error('Token exchange error:', error);
                            showError('Ошибка обмена токена: ' + error.message);
                        });
                });
                
                console.log('VK ID виджет инициализирован');
            } catch (error) {
                console.error('VK ID init error:', error);
                showError('Ошибка инициализации VK ID');
            }
        } else {
            console.error('VKIDSDK не найден в window');
            showError('Не удалось загрузить VK ID SDK');
        }
    };
    
    script.onerror = function() {
        console.error('Не удалось загрузить VK ID SDK');
        showError('Не удалось загрузить модуль VK ID. Проверьте подключение к интернету.');
        document.getElementById('vk_auth_container').innerHTML = 
            '<div class="alert alert-warning">' +
            '<i class="fas fa-exclamation-triangle me-2"></i>' +
            'VK ID временно недоступен. Используйте альтернативный способ входа.' +
            '</div>';
    };
    
    document.head.appendChild(script);

    // Функции для отображения сообщений
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        if (errorDiv && errorText) {
            errorText.textContent = message;
            errorDiv.classList.remove('d-none');
            const successDiv = document.getElementById('success-message');
            if (successDiv) successDiv.classList.add('d-none');
        }
    }
    
    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        const successText = document.getElementById('success-text');
        if (successDiv && successText) {
            successText.textContent = message;
            successDiv.classList.remove('d-none');
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) errorDiv.classList.add('d-none');
        }
    }
});
</script>
{% endblock %}
